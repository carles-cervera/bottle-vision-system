@startuml ARCHITECTURE
!theme plain

title Sistema d'Inspecci√≥ d'Ampolles en Temps Real (Arquitectura)

skinparam linetype ortho
left to right direction
skinparam nodesep 35
skinparam ranksep 45
skinparam packageStyle rectangle

' Llegenda: temps real (‚Äî) | offline (..)
legend left
    Temps real: ‚Äî
    Offline: ..
endlegend

package "üì∑ Font d'Imatges" {
    [C√†mera / Simulador\n(uploader)] as SOURCE
}

package "üñ•Ô∏è Frontend" {
    [UI Operador\n(React)] as FRONT
}

package "üîß Backend" {
    [FastAPI\nAPI + WebSocket] as BACK
}

package "‚òÅÔ∏è Azure Blob Storage" {
    [images-tap] as BLOB_TAP
    [images-level] as BLOB_LEVEL
    [errors-pdf] as BLOB_ERRORS
}

package "ü§ñ Azure ML (Infer√®ncia)" {
    [CNN TAP\n(endpoint)] as ML_TAP
    [CNN NIVELL\n(endpoint)] as ML_LEVEL
}

' --- Fluxos de dades ---

' MODE AUTOM√ÄTIC (via Blob)
SOURCE --> BLOB_TAP : "Upload TAP (+id, ts)"
SOURCE --> BLOB_LEVEL : "Upload NIVELL (+id, ts)"

' MODE INTERACTIU (usuari puja imatge)
FRONT --> BACK : "HTTP: analitzar imatge"

' Control d'estat (habilita/deshabilita mode autom√†tic)
FRONT --> BACK : "HTTP: ON/OFF"

' Flux temps real: detecci√≥, infer√®ncia, decisi√≥ i notificaci√≥
BACK --> BLOB_TAP : "Blob: lectura (autom√†tic)"
BACK --> BLOB_LEVEL : "Blob: lectura (autom√†tic)"
BACK --> ML_TAP : "HTTP: infer√®ncia"
BACK --> ML_LEVEL : "HTTP: infer√®ncia"
BACK --> FRONT : "WebSocket: resultats"

' 4) Flux offline/segon pla: persist√®ncia d'errors i evid√®ncies
BACK ..> BLOB_ERRORS : "PDF/evid√®ncia (NO OK)"

' --- Notes curtes (1 l√≠nia) ---

note right of FRONT
    UI: visualitza i activa/desactiva
end note

note right of BACK
    Backend: orquestra + decideix OK/NO OK
end note

note left of BACK
    2 modes
    - Interactiu: HTTP analitzar imatge
    - Autom√†tic: llegeix Blob quan est√† ON
end note

note right of ML_LEVEL
    IA: infer√®ncia (temps real)
end note

note bottom of BLOB_ERRORS
    Blob: nom√©s persistim errors/evid√®ncies
end note

@enduml